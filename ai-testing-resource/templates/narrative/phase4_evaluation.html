{% extends "narrative/base_narrative.html" %}
{% from "components/collapsible.html" import collapsible %}

{% block title %}Phase 4: Pre-Production Evaluation - AI Testing Resource{% endblock %}

{% block phase_intro %}
{% if intro_content %}
<section class="phase-intro">
  <div class="phase-intro__content">
    {{ intro_content | safe }}
  </div>
</section>
{% else %}
<section class="phase-intro">
  <div class="phase-intro__content">
    <p>Before deploying to production, we iterate on the AI's behavior through multiple versions. Each version addresses issues discovered in the previous one. Use the version tabs to see how the chatbot evolved from v1 (too verbose) through v2 (hallucinating) to v3 (accurate and grounded).</p>
  </div>
</section>
{% endif %}
{% endblock %}

{% block phase_content %}
<!-- Version Timeline Overview -->
<div class="narrative-content">
  <div class="timeline">
    <div class="timeline__version">
      <div class="timeline__circle timeline__circle--v1">v1</div>
      <span class="timeline__label">Too Verbose</span>
    </div>
    <span class="timeline__arrow">→</span>
    <div class="timeline__version">
      <div class="timeline__circle timeline__circle--v2">v2</div>
      <span class="timeline__label">Hallucinating</span>
    </div>
    <span class="timeline__arrow">→</span>
    <div class="timeline__version">
      <div class="timeline__circle timeline__circle--v3">v3</div>
      <span class="timeline__label">Accurate</span>
    </div>
  </div>

  <!-- Comparison Cards -->
  {% if comparison and comparison.versions %}
  <div class="comparison-cards">
    {% for version in comparison.versions %}
    <div class="comparison-card comparison-card--{{ version.id }}">
      <div class="comparison-card__header">{{ version.id | upper }}: {{ version.subtitle }}</div>
      <div class="comparison-card__body">
        <div class="comparison-card__label">Issue</div>
        <div class="comparison-card__value">{{ version.problem }}</div>
        <div class="comparison-card__label" style="margin-top: var(--space-md);">Fix Applied</div>
        <div class="comparison-card__value">{{ version.fix }}</div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

<!-- Trace Inspector Section -->
<div class="layout layout--sidebar">
  <!-- Sidebar: Version Tabs and Traces -->
  <aside>
    <div style="margin-bottom: var(--space-lg);">
      <h3 style="color: var(--color-chrome-text-bright); font-size: 0.875rem; margin: 0 0 var(--space-sm) 0;">
        Version
      </h3>
      <div class="version-tabs" style="flex-direction: column; width: 100%;">
        <a href="{{ url_for('narrative.phase_4', version='v1') }}"
           class="version-tab version-tab--v1 {% if current_version == 'v1' %}version-tab--active{% endif %}">
          V1 - Verbose
        </a>
        <a href="{{ url_for('narrative.phase_4', version='v2') }}"
           class="version-tab version-tab--v2 {% if current_version == 'v2' %}version-tab--active{% endif %}">
          V2 - Hallucinating
        </a>
        <a href="{{ url_for('narrative.phase_4', version='v3') }}"
           class="version-tab version-tab--v3 {% if current_version == 'v3' %}version-tab--active{% endif %}">
          V3 - Accurate
        </a>
      </div>
    </div>

    {% if traces %}
    <div>
      <h3 style="color: var(--color-chrome-text-bright); font-size: 0.875rem; margin: 0 0 var(--space-sm) 0;">
        Sample Traces
      </h3>
      <div class="sidebar">
        {% for trace in traces %}
        <a href="{{ url_for('narrative.phase_4', version=current_version, trace=trace.id) }}"
           class="sidebar__item {% if trace.id == selected_trace %}sidebar__item--active{% endif %}">
          {{ trace.question }}
          {% if trace.has_annotations %}
          <span style="color: var(--color-warning);">*</span>
          {% endif %}
        </a>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <div class="explanation">
      <p>No traces available for this version.</p>
    </div>
    {% endif %}
  </aside>

  <!-- Main Content -->
  <div class="content-primary">
    {% if trace_detail %}
    <!-- Question -->
    <div class="explanation">
      <h3 class="explanation__title">Question</h3>
      <div class="explanation__content">
        {{ trace_detail.question }}
      </div>
    </div>

    <!-- Response with Annotations (Primary - The Star) -->
    <div class="code-canvas">
      <div class="code-canvas__header">
        <span class="code-canvas__filename">Response</span>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span class="code-canvas__badge" style="background: var(--color-{{ 'warning' if current_version == 'v1' else 'error' if current_version == 'v2' else 'success' }});">
            {{ current_version | upper }}
          </span>
        </div>
      </div>
      <div class="code-canvas__code" style="font-family: var(--font-prose); white-space: pre-wrap;">
        {{ annotated_response | safe }}
      </div>

      <!-- Footnotes for annotations -->
      {% if trace_detail.annotations %}
      <div class="footnotes" style="padding: var(--space-md) var(--space-lg);">
        {% for ann in trace_detail.annotations %}
        <div class="footnote footnote--{{ ann.severity }}">
          <span class="footnote__marker">{{ loop.index }}</span>
          <span class="footnote__text">
            <strong>{{ ann.type | replace('_', ' ') | title }}:</strong>
            {{ ann.text }}
          </span>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- Secondary Content -->
    <div class="content-secondary">
      <!-- Prompt (Collapsible) -->
      <div class="collapsible">
        <button class="collapsible__trigger" onclick="toggleCollapsible(this.parentElement)">
          <span class="collapsible__icon">&#9654;</span>
          <span>View System Prompt</span>
        </button>
        <div class="collapsible__content">
          <pre style="font-family: var(--font-code); font-size: 0.8125rem; white-space: pre-wrap; color: var(--color-chrome-text-bright);">{{ trace_detail.prompt }}</pre>
        </div>
      </div>

      <!-- Metadata -->
      <div class="explanation">
        <h3 class="explanation__title">Metadata</h3>
        <div class="explanation__content">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm);">
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--color-chrome-text);">Latency</div>
              <div style="color: var(--color-chrome-text-bright);">{{ trace_detail.latency_ms }}ms</div>
            </div>
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--color-chrome-text);">Tokens</div>
              <div style="color: var(--color-chrome-text-bright);">{{ trace_detail.tokens.prompt }} + {{ trace_detail.tokens.completion }}</div>
            </div>
            {% if trace_detail.sources %}
            <div style="grid-column: span 2;">
              <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--color-chrome-text);">Sources</div>
              <div style="color: var(--color-chrome-text-bright);">
                {% for source in trace_detail.sources %}
                <span style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; font-size: 0.8125rem;">
                  {{ source.title }}
                </span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="explanation">
      <p>Select a trace from the sidebar to view its details.</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
