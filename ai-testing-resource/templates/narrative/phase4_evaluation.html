{% extends "narrative/base_narrative.html" %}
{% from "components/collapsible.html" import collapsible %}

{% block title %}Phase 4: Building AI Features - AI Testing Resource{% endblock %}

{% block phase_intro %}
{% if intro_content %}
<section class="phase-intro">
  <div class="phase-intro__content">
    {{ intro_content | safe }}
  </div>
</section>
{% else %}
<section class="phase-intro">
  <div class="phase-intro__content">
    <p>Before deploying to production, we iterate on the AI's behavior through multiple versions. Each version addresses issues discovered in the previous one. Use the version tabs to see how the chatbot evolved from v1 (too verbose) through v2 (hallucinating) to v3 (accurate and grounded).</p>
  </div>
</section>
{% endif %}
{% endblock %}

{% block phase_content %}
<!-- Version Timeline Overview -->
<div class="narrative-content">
  <div class="timeline">
    <div class="timeline__version">
      <div class="timeline__circle timeline__circle--v1">v1</div>
      <span class="timeline__label">Too Verbose</span>
    </div>
    <span class="timeline__arrow">&rarr;</span>
    <div class="timeline__version">
      <div class="timeline__circle timeline__circle--v2">v2</div>
      <span class="timeline__label">Hallucinating</span>
    </div>
    <span class="timeline__arrow">&rarr;</span>
    <div class="timeline__version">
      <div class="timeline__circle timeline__circle--v3">v3</div>
      <span class="timeline__label">Accurate</span>
    </div>
  </div>

  <!-- Comparison Cards -->
  {% if comparison and comparison.versions %}
  <div class="comparison-cards">
    {% for version in comparison.versions %}
    <div class="comparison-card comparison-card--{{ version.id }}">
      <div class="comparison-card__header">{{ version.id | upper }}: {{ version.subtitle }}</div>
      <div class="comparison-card__body">
        <div class="comparison-card__label">Issue</div>
        <div class="comparison-card__value">{{ version.problem }}</div>
        <div class="comparison-card__label" style="margin-top: var(--space-md);">Fix Applied</div>
        <div class="comparison-card__value">{{ version.fix }}</div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

<!-- Failure Mode Panel -->
<div id="failure-mode-section" class="narrative-content">
  {% if failure_modes %}
  <div class="failure-mode-panel failure-mode-panel--{{ current_version }}">
    <h3>Discovered Failure Modes ({{ current_version | upper }})</h3>
    {% for fm in failure_modes %}
    <div class="failure-mode-item failure-mode-item--{{ fm.severity }}">
      <strong>{{ fm.name }}</strong>
      <p>{{ fm.description }}</p>
      <span class="failure-mode-item__resolution">Resolution: {{ fm.resolution }}</span>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="failure-mode-panel failure-mode-panel--{{ current_version }}">
    <h3>Discovered Failure Modes ({{ current_version | upper }})</h3>
    <p style="color: var(--color-success); font-size: 0.875rem;">No failure modes &mdash; all evals pass.</p>
  </div>
  {% endif %}
</div>

<!-- Architecture Context (Collapsible) -->
<div id="arch-context-section" class="narrative-content">
  {% if arch_context %}
  <div class="collapsible">
    <button class="collapsible__trigger" onclick="toggleCollapsible(this.parentElement)">
      <span class="collapsible__icon">&#9654;</span>
      <span>Architecture Context ({{ current_version | upper }})</span>
    </button>
    <div class="collapsible__content">
      <div class="architecture-context">
        <h4>Prompt Strategy</h4>
        <p>{{ arch_context.prompt_strategy }}</p>
        <h4>Architecture</h4>
        <p>{{ arch_context.architecture }}</p>
        <h4>Known Limitations</h4>
        <p>{{ arch_context.known_limitations }}</p>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Annotation Methodology + Summary -->
{% if axial_codes and annotation_summary %}
<div class="narrative-content">
  <!-- Methodology Definitions -->
  <div class="methodology-definitions">
    <h3 class="methodology-definitions__title">Qualitative Coding Methodology</h3>
    <p class="methodology-definitions__intro">Each trace response is annotated using a two-level coding scheme (Husain &amp; Shankar):</p>
    <div class="methodology-definitions__terms">
      <div class="methodology-definitions__term">
        <strong>Open Code</strong>
        <span>Free-text observation specific to one trace (e.g., "Price stated as $349, actual is $299")</span>
      </div>
      <div class="methodology-definitions__term">
        <strong>Axial Code</strong>
        <span>Category label enabling quantification across traces (e.g., "Factual Hallucination")</span>
      </div>
    </div>
  </div>

  <!-- Annotation Summary Table -->
  <div class="annotation-summary">
    <h3 class="annotation-summary__title">Annotation Summary Across Versions</h3>
    <table class="annotation-summary__table">
      <thead>
        <tr>
          <th>Axial Code</th>
          <th>Category</th>
          <th>V1</th>
          <th>V2</th>
          <th>V3</th>
        </tr>
      </thead>
      <tbody>
        {% for code_id, code_info in axial_codes.items() %}
        {% set v1_count = annotation_summary.get('v1', {}).get(code_id, 0) %}
        {% set v2_count = annotation_summary.get('v2', {}).get(code_id, 0) %}
        {% set v3_count = annotation_summary.get('v3', {}).get(code_id, 0) %}
        {% if v1_count > 0 or v2_count > 0 or v3_count > 0 %}
        <tr>
          <td>
            <span class="annotation-item__axial-code annotation-item__axial-code--{{ code_info.severity }}">{{ code_info.label }}</span>
          </td>
          <td>{{ code_info.category }}</td>
          <td>{{ v1_count }}</td>
          <td>{{ v2_count }}</td>
          <td>{{ v3_count }}</td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- Trace Inspector Section -->
<div class="layout layout--sidebar">
  <!-- Sidebar: Version Tabs and Traces -->
  <aside>
    <div style="margin-bottom: var(--space-lg);">
      <h3 style="color: var(--color-chrome-text-bright); font-size: 0.875rem; margin: 0 0 var(--space-sm) 0;">
        Version
      </h3>
      <div class="version-tabs" style="flex-direction: column; width: 100%;">
        <button onclick="switchVersion('v1')" data-version="v1"
           class="version-tab version-tab--v1 {% if current_version == 'v1' %}version-tab--active{% endif %}">
          V1 - Verbose
        </button>
        <button onclick="switchVersion('v2')" data-version="v2"
           class="version-tab version-tab--v2 {% if current_version == 'v2' %}version-tab--active{% endif %}">
          V2 - Hallucinating
        </button>
        <button onclick="switchVersion('v3')" data-version="v3"
           class="version-tab version-tab--v3 {% if current_version == 'v3' %}version-tab--active{% endif %}">
          V3 - Accurate
        </button>
      </div>
    </div>

    <div id="trace-sidebar-section">
    {% if traces %}
    <div>
      <h3 style="color: var(--color-chrome-text-bright); font-size: 0.875rem; margin: 0 0 var(--space-sm) 0;">
        Sample Traces ({{ traces | length }})
      </h3>
      <div class="sidebar trace-sidebar-scroll">
        {% for trace in traces %}
        <a href="javascript:void(0)"
           class="sidebar__item {% if trace.id == selected_trace %}sidebar__item--active{% endif %}"
           data-trace-id="{{ trace.id }}"
           onclick="switchTrace('{{ current_version }}', '{{ trace.id }}')">
          {{ trace.question }}
          {% if trace.has_annotations %}
          <span style="color: var(--color-warning);">*</span>
          {% endif %}
        </a>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <div class="explanation">
      <p>No traces available for this version.</p>
    </div>
    {% endif %}
    </div>
  </aside>

  <!-- Main Content -->
  <div class="content-primary">
    {% if trace_detail %}
    <!-- Question -->
    <div class="explanation">
      <h3 class="explanation__title">Question</h3>
      <div class="explanation__content">
        {{ trace_detail.question }}
      </div>
    </div>

    <!-- Response with Annotations (Primary - The Star) -->
    <div class="code-canvas">
      <div class="code-canvas__header">
        <span class="code-canvas__filename">Response</span>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span class="code-canvas__badge" style="background: var(--color-{{ 'warning' if current_version == 'v1' else 'error' if current_version == 'v2' else 'success' }});">
            {{ current_version | upper }}
          </span>
        </div>
      </div>
      <div class="code-canvas__code" style="font-family: var(--font-prose); white-space: pre-wrap;">
        {{ annotated_response | safe }}
      </div>

      <!-- Annotations (axial code tags + open code text) -->
      {% if trace_detail.annotations %}
      <div class="annotations-section">
        <h4 class="annotations-section__title">Annotations</h4>
        {% for ann in trace_detail.annotations %}
        {% set code_info = axial_codes.get(ann.type, {}) %}
        <div class="annotation-item annotation-item--{{ ann.severity }}">
          <span class="annotation-item__axial-code annotation-item__axial-code--{{ ann.severity }}">{{ code_info.get('label', ann.type | replace('_', ' ') | title) }}</span>
          <span class="annotation-item__open-code">{{ ann.text }}</span>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- Secondary Content -->
    <div class="content-secondary">
      <!-- Prompt (Collapsible) -->
      <div class="collapsible">
        <button class="collapsible__trigger" onclick="toggleCollapsible(this.parentElement)">
          <span class="collapsible__icon">&#9654;</span>
          <span>View System Prompt</span>
        </button>
        <div class="collapsible__content">
          <pre style="font-family: var(--font-code); font-size: 0.8125rem; white-space: pre-wrap; color: var(--color-chrome-text-bright);">{{ trace_detail.prompt }}</pre>
        </div>
      </div>

      <!-- Metadata -->
      <div class="explanation">
        <h3 class="explanation__title">Metadata</h3>
        <div class="explanation__content">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm);">
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--color-chrome-text);">Latency</div>
              <div style="color: var(--color-chrome-text-bright);">{{ trace_detail.latency_ms }}ms</div>
            </div>
            <div>
              <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--color-chrome-text);">Tokens</div>
              <div style="color: var(--color-chrome-text-bright);">{{ trace_detail.tokens.prompt }} + {{ trace_detail.tokens.completion }}</div>
            </div>
            {% if trace_detail.sources %}
            <div style="grid-column: span 2;">
              <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--color-chrome-text);">Sources</div>
              <div style="color: var(--color-chrome-text-bright);">
                {% for source in trace_detail.sources %}
                <span style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; font-size: 0.8125rem;">
                  {{ source.title }}
                </span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <div class="explanation">
      <p>Select a trace from the sidebar to view its details.</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
