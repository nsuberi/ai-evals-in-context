{% extends "narrative/base_narrative.html" %}

{% block title %}Governance - AI Testing Resource{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/governance.css') }}">
{% endblock %}

{% block phase_intro %}
{% if intro_content %}
<section class="phase-intro">
  <div class="phase-intro__content">
    {{ intro_content | safe }}
  </div>
</section>
{% else %}
<section class="phase-intro">
  <div class="phase-intro__content">
    <p>The Test Summary Report is the central governance artifact. Each TSR is scoped to a specific release and documents what changed, what was tested, and whether the results meet the agreed criteria.</p>
  </div>
</section>
{% endif %}
{% endblock %}

{% block phase_content %}
<div class="narrative-content">
  <!-- Release Scoping Callout -->
  <div class="release-scoping-callout">
    Each Test Summary Report is scoped to the specific changes in a release&mdash;not a re-test of
    the entire application. This means TSRs are lightweight, focused artifacts that document what
    changed, what was tested, and whether it's safe to deploy.
  </div>

  <!-- Inline TSR Cards -->
  {% if tsrs %}
  <section>
    <h3 style="color: var(--color-chrome-text-bright); margin: 0 0 var(--space-lg) 0;">
      Test Summary Reports
    </h3>

    {% if stats %}
    <div class="stats-summary" style="margin-bottom: var(--space-xl);">
      <div class="stat-card">
        <div class="stat-card__value">{{ stats.total }}</div>
        <div class="stat-card__label">Total TSRs</div>
      </div>
      <div class="stat-card">
        <div class="stat-card__value" style="color: var(--color-success);">{{ stats.go }}</div>
        <div class="stat-card__label">GO Decisions</div>
      </div>
      <div class="stat-card">
        <div class="stat-card__value" style="color: var(--color-error);">{{ stats.no_go }}</div>
        <div class="stat-card__label">NO-GO Blocks</div>
      </div>
      <div class="stat-card">
        <div class="stat-card__value">{{ "%.0f"|format(stats.go_rate * 100) }}%</div>
        <div class="stat-card__label">Go Rate</div>
      </div>
    </div>
    {% endif %}

    <div class="tsr-list">
      {% for tsr in tsrs %}
      <div class="tsr-card tsr-card--{{ tsr.go_no_go_decision.value }}">
        <div class="tsr-card__header">
          <span class="tsr-card__id">{{ tsr.id[:12] }}</span>
          <span class="tsr-card__decision">
            {% if tsr.go_no_go_decision.value == 'go' %}&#10003; GO
            {% elif tsr.go_no_go_decision.value == 'no_go' %}&#10007; NO-GO
            {% else %}&#9203; PENDING{% endif %}
          </span>
        </div>
        <div class="tsr-card__meta">
          <div>Environment: <strong>{{ tsr.environment }}</strong></div>
          <div>Created: {{ tsr.created_at.strftime('%Y-%m-%d %H:%M UTC') }}</div>
          <div>Triggered by: {{ tsr.triggered_by }}</div>
        </div>
        {% if tsr.versions %}
        <div class="tsr-card__versions">
          Code: <code>{{ tsr.versions.codebase_sha[:7] }}</code><br>
          {% if tsr.versions.prompts_version %}
          Prompts: <code>{{ tsr.versions.prompts_version }}</code>
          {% endif %}
        </div>
        {% endif %}
        <button class="tsr-card__link" onclick="openTSRModal('{{ tsr.id }}', '{{ tsr.go_no_go_decision.value }}', '{{ tsr.id[:12] }}')">
          View Details &rarr;
        </button>
      </div>
      {% endfor %}
    </div>

    <div style="margin-top: var(--space-xl); text-align: center;">
      <a href="{{ url_for('governance.dashboard') }}" class="landing-cta" style="display: inline-flex;">
        Open Full TSR Dashboard
        <span>&rarr;</span>
      </a>
    </div>
  </section>
  {% else %}
  <!-- No TSRs fallback -->
  <div class="tsr-empty-state">
    <p>No Test Summary Reports found in the database.</p>
    <p>Run <code>python3 scripts/seed_test_data.py</code> to create sample TSR data.</p>
  </div>
  {% endif %}

  {% include "components/tsr_modal.html" %}

  <!-- Journey Complete -->
  <section class="content-section content-section--open" style="border-color: var(--color-success); border-width: 2px; margin-top: var(--space-2xl);">
    <div class="content-section__header">
      <span class="content-section__icon" style="color: var(--color-success);">!</span>
      <h3 class="content-section__title" style="color: var(--color-success);">Journey Complete</h3>
    </div>
    <div class="content-section__body">
      <p>You've followed Acme Widget Co through the complete AI development lifecycle:</p>

      <ol>
        <li><strong>Problem Definition:</strong> Identified business needs and success criteria</li>
        <li><strong>Requirements:</strong> Extracted functional requirements from stakeholders</li>
        <li><strong>Design:</strong> Architected a RAG-based solution with testing strategy</li>
        <li><strong>Implementation:</strong> Built code with traditional tests + AI evals</li>
        <li><strong>Evaluation:</strong> Iterated through v1&rarr;v2&rarr;v3 based on eval results</li>
        <li><strong>Production:</strong> Deployed with monitoring and governance</li>
      </ol>

      <p style="margin-top: var(--space-lg);"><strong>Key Takeaway:</strong> AI evals are acceptance tests for AI behavior. They sit alongside traditional tests in the test pyramid, validating that AI systems meet requirements for accuracy, grounding, and appropriate behavior. The TSR captures this evidence in a lightweight artifact scoped to each release.</p>

      <div style="margin-top: var(--space-xl); text-align: center;">
        <a href="{{ url_for('narrative.landing') }}" class="phase-nav-btn phase-nav-btn--prev" style="display: inline-flex;">
          <span class="phase-nav-btn__arrow">&larr;</span>
          <span class="phase-nav-btn__text">
            <span class="phase-nav-btn__label">Return to</span>
            <span class="phase-nav-btn__title">Start</span>
          </span>
        </a>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block phase_navigation %}
<!-- Custom navigation for governance (last page) -->
<nav class="phase-nav-bottom">
  <a href="{{ url_for('narrative.phase_5') }}" class="phase-nav-btn phase-nav-btn--prev">
    <span class="phase-nav-btn__arrow">&larr;</span>
    <span class="phase-nav-btn__text">
      <span class="phase-nav-btn__label">Previous</span>
      <span class="phase-nav-btn__title">Phase 5</span>
    </span>
  </a>
  <div></div>
</nav>
{% endblock %}
