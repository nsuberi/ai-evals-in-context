{% extends "base.html" %}

{% block title %}TSR Governance Portal{% endblock %}

{% block head %}
<style>
  .governance-portal {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--space-xl);
  }

  .gov-header {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-lg);
    border-bottom: 2px solid var(--color-accent);
  }

  .gov-header__icon {
    font-size: 2rem;
  }

  .gov-header h1 {
    color: var(--color-chrome-text-bright);
    margin: 0;
    font-size: 1.75rem;
  }

  .gov-filters {
    display: flex;
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
    flex-wrap: wrap;
  }

  .gov-filters select {
    padding: var(--space-sm) var(--space-md);
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    color: var(--color-chrome-text-bright);
    font-family: var(--font-prose);
    font-size: 0.875rem;
  }

  .tsr-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: var(--space-lg);
  }

  .tsr-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: var(--space-lg);
    transition: all 0.2s ease;
  }

  .tsr-card:hover {
    background: rgba(255, 255, 255, 0.05);
    transform: translateY(-2px);
  }

  .tsr-card--go {
    border-left: 4px solid var(--color-success);
  }

  .tsr-card--no_go {
    border-left: 4px solid var(--color-error);
  }

  .tsr-card--pending_review {
    border-left: 4px solid var(--color-warning);
  }

  .tsr-card__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
  }

  .tsr-card__id {
    font-family: var(--font-code);
    font-size: 0.8125rem;
    color: var(--color-chrome-text);
  }

  .tsr-card__decision {
    font-weight: 600;
    font-size: 0.875rem;
    padding: var(--space-xs) var(--space-sm);
    border-radius: 4px;
  }

  .tsr-card--go .tsr-card__decision {
    background: var(--color-ann-success-bg);
    color: var(--color-success);
  }

  .tsr-card--no_go .tsr-card__decision {
    background: var(--color-ann-error-bg);
    color: var(--color-error);
  }

  .tsr-card--pending_review .tsr-card__decision {
    background: var(--color-ann-warning-bg);
    color: var(--color-warning);
  }

  .tsr-card__meta {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    margin-bottom: var(--space-md);
    font-size: 0.8125rem;
    color: var(--color-chrome-text);
  }

  .tsr-card__versions {
    font-family: var(--font-code);
    font-size: 0.75rem;
    color: var(--color-chrome-text);
    padding: var(--space-sm);
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
    margin-bottom: var(--space-sm);
  }

  .tsr-card__link {
    display: inline-block;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-accent);
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.8125rem;
    font-weight: 500;
    transition: background 0.15s ease;
  }

  .tsr-card__link:hover {
    background: var(--color-accent-hover);
  }

  .stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
  }

  .stat-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: var(--space-lg);
    text-align: center;
  }

  .stat-card__value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-chrome-text-bright);
    margin-bottom: var(--space-xs);
  }

  .stat-card__label {
    font-size: 0.875rem;
    color: var(--color-chrome-text);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
</style>
{% endblock %}

{% block content %}
<div class="governance-portal">
  <header class="gov-header">
    <span class="gov-header__icon">üèõÔ∏è</span>
    <h1>AI Governance & Compliance Portal</h1>
  </header>

  {% if stats %}
  <div class="stats-summary">
    <div class="stat-card">
      <div class="stat-card__value">{{ stats.total }}</div>
      <div class="stat-card__label">Total TSRs</div>
    </div>
    <div class="stat-card">
      <div class="stat-card__value" style="color: var(--color-success);">{{ stats.go }}</div>
      <div class="stat-card__label">GO Decisions</div>
    </div>
    <div class="stat-card">
      <div class="stat-card__value" style="color: var(--color-error);">{{ stats.no_go }}</div>
      <div class="stat-card__label">NO-GO Blocks</div>
    </div>
    <div class="stat-card">
      <div class="stat-card__value">{{ "%.1f"|format(stats.go_rate * 100) }}%</div>
      <div class="stat-card__label">Success Rate</div>
    </div>
  </div>
  {% endif %}

  <div class="gov-filters">
    <select id="filter-environment" onchange="filterTSRs()">
      <option value="">All Environments</option>
      <option value="test">Test</option>
      <option value="staging">Staging</option>
      <option value="production">Production</option>
    </select>
    <select id="filter-decision" onchange="filterTSRs()">
      <option value="">All Decisions</option>
      <option value="go">GO</option>
      <option value="no_go">NO-GO</option>
      <option value="pending_review">Pending Review</option>
    </select>
  </div>

  <div class="tsr-list">
    {% for tsr in tsrs %}
    <div class="tsr-card tsr-card--{{ tsr.go_no_go_decision.value }}"
         data-environment="{{ tsr.environment }}"
         data-decision="{{ tsr.go_no_go_decision.value }}">
      <div class="tsr-card__header">
        <span class="tsr-card__id">{{ tsr.id[:12] }}</span>
        <span class="tsr-card__decision">
          {% if tsr.go_no_go_decision.value == 'go' %}‚úÖ GO
          {% elif tsr.go_no_go_decision.value == 'no_go' %}‚ùå NO-GO
          {% else %}‚è≥ PENDING{% endif %}
        </span>
      </div>
      <div class="tsr-card__meta">
        <div>Environment: <strong>{{ tsr.environment }}</strong></div>
        <div>Created: {{ tsr.created_at.strftime('%Y-%m-%d %H:%M UTC') }}</div>
        <div>Triggered by: {{ tsr.triggered_by }}</div>
      </div>
      {% if tsr.versions %}
      <div class="tsr-card__versions">
        Code: <code>{{ tsr.versions.codebase_sha[:7] }}</code><br>
        {% if tsr.versions.prompts_version %}
        Prompts: <code>{{ tsr.versions.prompts_version }}</code>
        {% endif %}
      </div>
      {% endif %}
      <a href="{{ url_for('governance.tsr_detail', tsr_id=tsr.id) }}" class="tsr-card__link">
        View Details ‚Üí
      </a>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function filterTSRs() {
  const envFilter = document.getElementById('filter-environment').value;
  const decisionFilter = document.getElementById('filter-decision').value;
  const cards = document.querySelectorAll('.tsr-card');

  cards.forEach(card => {
    const env = card.dataset.environment;
    const decision = card.dataset.decision;

    const envMatch = !envFilter || env === envFilter;
    const decisionMatch = !decisionFilter || decision === decisionFilter;

    card.style.display = (envMatch && decisionMatch) ? 'block' : 'none';
  });
}
</script>
{% endblock %}
